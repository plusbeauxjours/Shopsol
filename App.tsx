import React, {useEffect} from 'react';
import {BackHandler, ToastAndroid, Platform} from 'react-native';

import codePush from 'react-native-code-push';
import messaging from '@react-native-firebase/messaging';
import PushNotification from 'react-native-push-notification';
import {Provider} from 'react-redux';
import {PersistGate} from 'redux-persist/integration/react';
import {RootSiblingParent} from 'react-native-root-siblings';
import appsFlyer from 'react-native-appsflyer';
import * as Sentry from '@sentry/react-native';

import store, {persistor} from './src/redux/store';
import RootContainer from './src/navigations/RootContainer';

function App() {
  // ì•±ìŠ¤í”Œë¼ì´ì–´ SDK (feat.ëŒ€í‘œë‹˜)
  appsFlyer.initSdk(
    {
      devKey: 'HWrK6iFipjPUqDhwJUABpA',
      isDebug: false,
      appId: '1408364175',
      onInstallConversionDataListener: true,
      onDeepLinkListener: true,
    },
    (result) => {
      console.log('AppsFlyer SDK successfully initialized: ', result);
    },
    (error) => {
      console.error('AppsFlyer SDK initialization threw an error: ', error);
    },
  );

  // ì„¼íŠ¸ë¦¬ SDK
  Sentry.init({
    dsn:
      'https://920fb530d09442768b04ec6825a3a2b4@o450648.ingest.sentry.io/5457931',
    enableAutoSessionTracking: true,
    sessionTrackingIntervalMillis: 10000,
  });

  // ì•ˆë“œë¡œì´ë“œ ë°±ë²„íŠ¼ ë‘ë²ˆ íƒ­í•˜ì—¬ ì•±ì¢…ë£Œ
  let exitApp;
  const handleBackButton = () => {
    if (!exitApp || exitApp == undefined) {
      exitApp = true;
      ToastAndroid.show('í•œë²ˆ ë” ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤.', 2000);
      setTimeout(() => {
        exitApp = false;
        clearTimeout();
      }, 2000);
    } else {
      clearTimeout();
      BackHandler.exitApp();
      exitApp = false;
    }
    return true;
  };

  ////////////////// LOCAL_PUSH_NOTIFICATION ////////////////////////////////////
  //
  //   1) ì•±ì´ ì¼œì ¸ìˆì„ ë•ŒëŠ”(foreground) push notificationì„ ëª»í•˜ëŠ” ì´ìŠˆê°€ ìˆì–´ì„œ (feat.í—ˆêµ°ë‹˜)
  //   local-push-notificationì„ ì‚¬ìš©
  //   https://dev-yakuza.posstree.com/ko/react-native/react-native-push-notification/
  //
  //   2) ì•±ì´ êº¼ì§€ë©´(background) foregounrdì—ì„œ ì‚¬ìš©í•˜ëŠ”
  //   local-push-notificationì„ ë”
  //
  ///////////////////////////////////////////////////////////////////////////////

  // local-push-notificationë“±ë¡Fn
  const register = async () => {
    if (Platform.OS === 'android') {
      BackHandler.addEventListener('hardwareBackPress', handleBackButton);
    }
    PushNotification.getApplicationIconBadgeNumber((number) => {
      if (number > 0) {
        PushNotification.setApplicationIconBadgeNumber(0);
      }
    });
    PushNotification.configure({
      popInitialNotification: true,
      onRegister: () => {
        console.log('onRegister');
      },
      onNotification: () => {
        console.log('onNotification');
      },
      permissions: {
        alert: true,
        badge: true,
        sound: true,
      },
      requestPermissions: true,
    });
  };

  messaging().setBackgroundMessageHandler(async (remoteMessage) => {
    console.log('Message handled in the background1!', remoteMessage);
  });

  // local-push-notificationì˜ ìŠ¤íƒ€ì¼ê³¼, ì˜µì…˜
  const localNotif = (remoteMessage) => {
    PushNotification.localNotification({
      /* Android Only Properties */
      id: remoteMessage.messageId, // (optional) Valid unique 32 bit integer specified as string. default: Autogenerated Unique ID
      autoCancel: true, // (optional) default: true
      largeIcon: '', // (optional) default: "ic_launcher"
      smallIcon: '', // (optional) default: "ic_notification" with fallback for "ic_launcher"
      bigText: remoteMessage.notification.title, // (optional) default: "message" prop
      color: 'red', // (optional) default: system default
      vibrate: true, // (optional) default: true
      vibration: 300, // vibration length in milliseconds, ignored if vibrate=false, default: 1000
      ongoing: false, // (optional) set whether this is an "ongoing" notification

      /* iOS only properties */
      alertAction: 'view', // (optional) default: view

      /* iOS and Android properties */
      title: remoteMessage.notification.title, // (optional)
      message: remoteMessage.notification.body, // (required)
    });
  };

  // local-push-notificationë“±ë¡
  useEffect(() => {
    register();
    messaging().onMessage(async (remoteMessage) => {
      localNotif(remoteMessage);
      console.log('Message handled in the background2!', remoteMessage);
    });
  }, []);

  // local-push-notificationí•´ì œ
  useEffect(() => {
    return () => {
      PushNotification.cancelAllLocalNotifications();
    };
  }, []);

  return (
    <Provider store={store}>
      <PersistGate persistor={persistor}>
        <RootSiblingParent>
          <RootContainer />
        </RootSiblingParent>
      </PersistGate>
    </Provider>
  );
}

////////////////// CODE_PUSH ////////////////////////////////////
//
//   1) https://appcenter.ms/apps ì—ì„œ ê´€ë¦¬
//   2) https://appcenter.ms/users/shopsol.master-gmail.com/apps/shopsolWesop-android/distribute/code-push ì—ì„œ ì½”ë“œí‘¸ì‹œë²„ì „ í™•ì¸
//   3) https://appcenter.ms/users/shopsol.master-gmail.com/apps/shopsolWesop-android/settings/webhooks ì—ì„œ webhookì„ slackìœ¼ë¡œ ë‚ ë¦¼
//
//   4) js, tsê°€ ë°”ë€” ê²½ìš° ì•„ë˜ì˜ ëª…ë ¹ì–´ğŸ™ë¥¼ í†µí•˜ì—¬ ìŠ¤í† ì–´ ì‹¬ì‚¬ì—†ì´ ì ìš© ê°€ëŠ¥
//   5) ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ëŠ” ê²½ìš°, íŒ¨í‚¤ì§€ê°€ ì¶”ê°€ë˜ëŠ” ê²½ìš°, nativeë¶€ë¶„ì´ ìˆ˜ì •ëœ ê²½ìš° ì½”ë“œí‘¸ì‹œë¡œ ì ìš© ë¶ˆê°€ëŠ¥, ìŠ¤í† ì–´ ì‹¬ì‚¬ë¥¼ í†µí•´ì„œ ì—…ë°ì´íŠ¸í•´ì•¼í•¨
//   6) ìƒˆë¡œìš´ ì½”ë“œí‘¸ì‹œê°€ ì ìš© ë  ë•Œ ì•±ì´ ê¹œë¹¡ì´ë©° ì²˜ìŒì˜ navigationìœ¼ë¡œ ì´ë™í•˜ëŠ” í˜„ìƒìˆìŒ
//
//////////////////////////////////////////////////////////////////

// ì½”ë“œí‘¸ì‹œ ì…‹íŒ…
const codePushOptions = {
  checkFrequency: codePush.CheckFrequency.ON_APP_START, // ìƒˆë¡œìš´ ì½”ë“œí‘¸ì‹œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” íƒ€ì´ë°
  updateDialog: false,
  installMode: codePush.InstallMode.IMMEDIATE, // ìƒˆë¡œìš´ ì½”ë“œí‘¸ì‹œë¥¼ ì ìš©í•˜ëŠ” íƒ€ì´ë°
};

export default codePush(codePushOptions)(App);

// Andrioid
// shopsol.master-gmail.com/shopsolWesop-android
// appcenter codepush release-react -a shopsol.master-gmail.com/shopsolWesop-android -d Production  // ì•ˆë“œë¡œì´ë“œ ì½”ë“œí‘¸ì‹œë¥¼ í•  ë•Œì˜ ëª…ë ¹ì–´ğŸ™ì´ì§€ë§Œ codepush:androidë¡œ ì½”ë“œí‘¸ì‹œí•´ì•¼í•¨
// SLACKì˜ #ìƒµì†”-ì½”ë“œí‘¸ì‹œ ì±„ë„ì˜ ì½”ë“œí‘¸ì‹œ ë²„ì „ê³¼ ì•±ì˜ ë²„ì „ì„ ë™ê¸°í™”í•˜ê¸° ìœ„í•¨
// appcenter codepush deployment list -a shopsol.master-gmail.com/shopsolWesop-android -k // ì²˜ìŒì— ì½”ë“œí‘¸ì‹œë¥¼ ì„¸íŒ…í•  ë•Œ https://appcenter.ms/appsì— ë””í”Œë¡œì´ë¥¼ ìœ„í•œ ëª…ë ¹ì–´
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Name       â”‚ Key                                   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Production â”‚ IQ-khtu0aKK5BdIbO4km_EtFgAQjWBnmiq-T6 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// iOS
// shopsol.master-gmail.com/shopsolWesop-ios
// appcenter codepush release-react -a shopsol.master-gmail.com/shopsolWesop-ios -d Production  // IOS ì½”ë“œí‘¸ì‹œë¥¼ í•  ë•Œì˜ ëª…ë ¹ì–´ğŸ™ì´ì§€ë§Œ codepush:androidë¡œ ì½”ë“œí‘¸ì‹œí•´ì•¼í•¨
// SLACKì˜ #ìƒµì†”-ì½”ë“œí‘¸ì‹œ ì±„ë„ì˜ ì½”ë“œí‘¸ì‹œ ë²„ì „ê³¼ ì•±ì˜ ë²„ì „ì„ ë™ê¸°í™”í•˜ê¸° ìœ„í•¨
// appcenter codepush deployment list -a shopsol.master-gmail.com/shopsolWesop-ios -k // ì²˜ìŒì— ì½”ë“œí‘¸ì‹œë¥¼ ì„¸íŒ…í•  ë•Œ https://appcenter.ms/appsì— ë””í”Œë¡œì´ë¥¼ ìœ„í•œ ëª…ë ¹ì–´
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Name       â”‚ Key                                   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Production â”‚ KJJ3ieWUWc4o6dSzHZxZXdSayNHMvsvlC9U6y â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
